@using Microsoft.AspNetCore.Http
@{
    ViewBag.Title = "LetsChat";

}


<h2>Lets Chat</h2>
<link href="~/css/sweetalert2.css" rel="stylesheet" />

<div class="form-group col-xl-12">
    <label class="control-label">Your connection Id: </label><p class="control-label" id="yourConnectionId"></p><br />
    <input type="text" class="col-lg-12 text-primary" id="frndConnId" placeholder="Paste your friend's connection Id" /><br /><br />
    <label class="control-label">Your Message</label><br />
    <textarea type="text" class="col-lg-10 text-primary" id="message"></textarea>

    <input type="button" class="btn btn-primary" id="sendmessage" value="Send" /><br /><br />
    <div class="container chatArea">
        <input type="hidden" id="displayname" />
        <ul id="discussion"></ul>
    </div>
</div>
<br />
<input type="hidden" id="connId" />

<!--Reference the autogenerated SignalR hub script. -->
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script>
    //var userName = "";
    //var sessionVal = '';
    $(function () {
        // Reference the auto-generated proxy for the hub.
        var connection = new signalR.HubConnectionBuilder().withUrl("/privatechathub").build();
        var connectionId = null;

        connection.start().then(async function () {
            document.getElementById("sendmessage").disabled = false;
            connectionId = await getConnectionId();
            connection.invoke("AddUserList", '@Context.Session.GetString("Username")', connectionId);
        }).catch(function (err) {
            return console.error(err.toString());
            });

        async function getConnectionId() {
            return connection.invoke("GetConnectionId");
        }

        $('#sendmessage').click(async function () {
            // Call the Send method on the hub.
            var connId = $("#connId").val();
            var frndConnId = $("#frndConnId").val();
            
            connection.invoke("SendMessage", $('#displayname').val(), $('#message').val(), frndConnId, connectionId);
            $("#connId").val(connectionId);
            if (frndConnId == "") {
                
            }
            // Clear text box and reset focus for next comment.
            $('#discussion').append('<li><strong>' + htmlEncode($('#displayname').val())
                + '</strong>: ' + htmlEncode($('#message').val()) + '</li>');
            $('#message').val('').focus();
        });

        // Create a function that the hub can call back to display messages.
        connection.on("ReceiveMessage", function (user, message, fromConnectionId) {
            var msg = message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            var encodedMsg = user + " says " + msg;
            var li = document.createElement("li");
            li.textContent = encodedMsg;
            $('#discussion').append('<li><strong>' + htmlEncode(user)
                + '</strong>: ' + htmlEncode(message) + '</li>');
            $("#frndConnId").val(fromConnectionId);
        });

        // Get the user name and store it to prepend to messages.
        swal("Enter your name",{
            title: "Lets Chat!",
            content: "input",
            html: true,
            showCancelButton: true,
            closeOnConfirm: true,
            animation: "slide-from-top",
            inputPlaceholder: "Your Name"
        }).then((value) => 
             {
                userName = value;
            if (userName === false) return false;
            if (userName === "") {
                    swal.showInputError("You need to type your name!");
                    return false;
            }
            
            swal("You connection Id", connectionId, "success");
                 document.getElementById('yourConnectionId').innerHTML = connectionId;
                $('#displayname').val(userName);
                return true;
            });
        // Set initial focus to message input box.
        $('#message').focus();
        $('#message').keypress(function (e) {
            if (e.which == 13) {//Enter key pressed
                $('#sendmessage').trigger('click');//Trigger search button click event
            }
        });
    });
    // This optional function html-encodes messages for display in the page.
    function htmlEncode(value) {
        var encodedValue = $('<div />').text(value).html();
        return encodedValue;
    }
</script>