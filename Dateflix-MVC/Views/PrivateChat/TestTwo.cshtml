@using Microsoft.AspNetCore.Http
@{
    ViewBag.Title = "LetsChat";

}


<h2>Lets Chat</h2>
<link href="~/css/sweetalert2.css" rel="stylesheet" />

<div class="form-group col-xl-12">
    <label class="control-label">Your connection Id: </label><p class="control-label" id="yourConnectionId"></p><br />
    <input type="text" class="col-lg-12 text-primary" id="frndConnId" placeholder="Paste your friend's connection Id" /><br /><br />
    <input type="text" class="col-lg-12 text-primary" id="frndUsername" placeholder="Paste your friend's username" />
    <input type="button" class="btn btn-info" id="getMessages" value="Get messages" /><br /><br />
    <label class="control-label">Your Message</label><br />
    <textarea type="text" class="col-lg-10 text-primary" id="message"></textarea>

    <input type="button" class="btn btn-primary" id="sendmessage" value="Send" /><br /><br />
    <div class="container chatArea">
        <input type="hidden" id="displayname" />
        <ul id="discussion"></ul>
    </div>
</div>
<br />
<input type="hidden" id="connId" />

<!--Reference the autogenerated SignalR hub script. -->
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
<script>
    var email = "";
    //var sessionVal = '';
    var connection = new signalR.HubConnectionBuilder().withUrl("/privatechathub?email=test1@test.com").build();
    var connectionId = null;
    async function getConnectionId() {
        return connection.invoke("GetConnectionId");
    }

    function startChatConnection() {
        connection.start().then(async function () {
            connectionId = await getConnectionId();
            document.getElementById("sendmessage").disabled = false;
            document.getElementById('yourConnectionId').innerHTML = connectionId;
            $('#displayname').val(email);
            swal("You connection Id", connectionId, "success");
            }).catch(function (err) {
            return console.error(err.toString());
            });

        $('#sendmessage').click(async function () {
            // Call the Send method on the hub.
            var connId = $("#connId").val();
            var frndConnId = $("#frndConnId").val();
            
            connection.invoke("SendMessage", $('#message').val(), $('#displayname').val(), connectionId, frndConnId, $("#frndUsername").val());
            $("#connId").val(connectionId);
            if (frndConnId == "") {
                
            }
            // Clear text box and reset focus for next comment.
            $('#discussion').append('<li><strong>' + htmlEncode($('#displayname').val())
                + '</strong>: ' + htmlEncode($('#message').val()) + '</li>');
            $('#message').val('').focus();

            //var friendConnectionId = connection.invoke("GetConnectionIdFromEmail", $("#frndConnId").val(), null);
            //$('#frndConnId').val(friendConnectionId);
        });

        $('#getMessages').click(async function() {
            var messages = await connection.invoke("GetMessages", email, $("#frndUsername").val());

            console.log(messages.val);
            messages.forEach(function (message) {
                var msg = message.message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                var encodedMsg = message.senderFirstname + " says " + msg;
                var li = document.createElement("li");
                li.textContent = encodedMsg;
                $('#discussion').append('<li><strong>' + htmlEncode(message.senderFirstname)
                    + '</strong>: ' + htmlEncode(message.message) + '</li>');
            });
        });

        connection.on("GetMessages", function (messages) {
            
        });

        connection.on("ReceiveMessage", function (user, message, fromConnectionId) {
            var msg = message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            var encodedMsg = user + " says " + msg;
            var li = document.createElement("li");
            li.textContent = encodedMsg;
            $('#discussion').append('<li><strong>' + htmlEncode(user)
                + '</strong>: ' + htmlEncode(message) + '</li>');
            $("#frndConnId").val(fromConnectionId);
        });
    }
    

    $(function () {
        // Get the user name and store it to prepend to messages.
        swal("Enter your name",{
            title: "Lets Chat!",
            content: "input",
            html: true,
            showCancelButton: true,
            closeOnConfirm: true,
            animation: "slide-from-top",
            inputPlaceholder: "Your Name"
        }).then((value) => 
             {
                email = value;
            if (email === false) return false;
            if (email === "") {
                swal.showInputError("You need to type your name!");
                return false;
            }
                 
                 startChatConnection();
             });
        // Set initial focus to message input box.
        $('#message').focus();
        $('#message').keypress(function (e) {
            if (e.which == 13) {//Enter key pressed
                $('#sendmessage').trigger('click');//Trigger search button click event
            }
        });
    });

    // This optional function html-encodes messages for display in the page.
    function htmlEncode(value) {
        var encodedValue = $('<div />').text(value).html();
        return encodedValue;
    }
</script>